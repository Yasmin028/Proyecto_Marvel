{% extends 'base.html' %}

{% block content %}
<section class="section bg-estelar">
  <div class="container">
    <h1 class="title has-text-warning has-text-centered" style="font-size: 8rem;">✨ Curiosidades</h1>

    <!-- ✅ MENSAJE DE CONFIRMACIÓN -->
    {% if mensaje %}
      <div class="notification is-success is-light has-text-centered">
        {{ mensaje }}
      </div>
    {% endif %}

    <!-- ✅ MENSAJE DE ERROR -->
    {% if mensaje_error %}
      <div class="notification is-danger is-light has-text-centered">
        {{ mensaje_error }}
      </div>
    {% endif %}

    <!-- ✅ FORMULARIO PARA CREAR CURIOSIDAD -->
    <div class="box" style="margin-top: 2rem; background: rgba(0,0,0,0.8); border: 3px solid #e62429;">
      <h2 class="title is-3 has-text-warning has-text-centered">Agregar nueva curiosidad</h2>

      <form action="/curiosidades" method="post">
        <div class="columns">
          <div class="column is-half">

            <div class="field">
              <label class="label has-text-white">Texto de la curiosidad</label>
              <div class="control">
                <!-- ✅ AGREGADO: min, max y contador -->
                <textarea class="textarea" 
                          name="contenido" 
                          id="contenido"
                          minlength="10"
                          maxlength="300"
                          required></textarea>

                <p id="contador" class="has-text-grey-light mt-1">
                  0 / 300 caracteres
                </p>
              </div>
            </div>

          </div>

          <div class="column is-half">

            <div class="field">
              <label class="label has-text-white">Película relacionada</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select name="pelicula_id" required>
                    {% for pelicula in peliculas %}
                      <option value="{{ pelicula.id }}">{{ pelicula.titulo }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <div class="field has-text-centered" style="margin-top: 2rem;">
              <button class="button is-danger is-medium">
                Guardar curiosidad
              </button>
            </div>

          </div>
        </div>
      </form>
    </div>
    <!-- ✅ FIN FORMULARIO -->

    {% if curiosidades %}
      <h2 class="title has-text-warning">Listado de Curiosidades</h2>
      <div class="columns is-multiline">

        {% for curiosidad in curiosidades %}
          <div class="column is-one-third">

            <div class="curiosidad-card" id="card-{{ curiosidad.id }}">

              <div class="curiosidad-card-image">
                {% if curiosidad.pelicula and curiosidad.pelicula.imagen_url %}
                  <img src="{{ curiosidad.pelicula.imagen_url }}" alt="{{ curiosidad.pelicula.titulo }}">
                {% else %}
                  <div class="placeholder"><span class="placeholder-text">SIN IMAGEN</span></div>
                {% endif %}
              </div>

              <div class="has-text-centered mt-2">
                <a href="/curiosidades/{{ curiosidad.id }}/page">
                  {{ curiosidad.pelicula.titulo if curiosidad.pelicula else "Sin título" }}
                </a>
              </div>

              <form action="/curiosidades/{{ curiosidad.id }}" method="post" style="margin-top: 1rem;" onsubmit="return confirm('¿Eliminar esta curiosidad?');">
                <input type="hidden" name="method" value="delete">
                <div class="has-text-centered">
                  <button class="button is-small is-danger">Eliminar</button>
                </div>
              </form>

            </div>
          </div>
        {% endfor %}

      </div>

    {% else %}
      <p class="has-text-centered has-text-grey is-size-4">No hay curiosidades registradas aún.</p>
    {% endif %}

  </div>
</section>

<!-- ✅ SCRIPT DEL CONTADOR -->
<script>
  const textarea = document.getElementById("contenido");
  const contador = document.getElementById("contador");

  textarea.addEventListener("input", () => {
    const length = textarea.value.length;
    contador.textContent = `${length} / 300 caracteres`;

    if (length < 10) {
      contador.classList.remove("has-text-success");
      contador.classList.add("has-text-danger");
    } else if (length > 300) {
      contador.classList.remove("has-text-success");
      contador.classList.add("has-text-danger");
    } else {
      contador.classList.remove("has-text-danger");
      contador.classList.add("has-text-success");
    }
  });
</script>

{% endblock %}